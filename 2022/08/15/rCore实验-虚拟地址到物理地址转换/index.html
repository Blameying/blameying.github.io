<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="renderer" content="webkit">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <meta name="google-site-verification" content="TZE0rZyIqLl10trYu3BWBWa1Vmz6HFwhb2OcNEK4u-s" />
     <link rel="shortcut icon" href= /img/favicon.png >
    <title>
        XBlame&#39;s Blog
    </title>
    <meta name="description" content= å¤©æ‰Blameçš„æŠ€æœ¯å’Œç”Ÿæ´»éšç¬”, å¸Œæœ›èƒ½åœ¨æ± æ°´é‡Œç•™ä¸‹æ¶Ÿæ¼ª >
    <meta name="keywords" content= Blog,C,Python,Ruby,è®¡ç®—æœº,åµŒå…¥å¼,æŠ€æœ¯,ä½“ç³»ç»“æ„,ç”Ÿæ´»,éšç¬” >
    
<link rel="stylesheet" href="/libs/highlight/styles/monokai-sublime.css">

    
<link rel="stylesheet" href="/libs/font-awesome/css/font-awesome.min.css">

    
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 6.1.0"></head>
<body id="bodyx">
    <div class="hd">
    <ol class="breadcrumb">
        <li><img src="/img/favicon.png" class="logopng" alt="logo"></li>
        <li>
            <a href="/index.html"><i class="fa fa-home replay-btn" aria-hidden="true"></i></a>
        </li>
        <li>XBlame</li>
        <!--
        <li class="words" style="font-weight: bold;font-family: Georgia;"> 
                ä½ ä¸ºä»€ä¹ˆå°±ä¸æ˜¯è‚¯è®¤åŒå¤§å®¶çš„åŠªåŠ›ï¼Ÿå°±å› ä¸ºä»–ä»¬æ¯”ä½ æ…¢å—ï¼Ÿä½ çš„ä»·å€¼æ ‡å‡†å°±åªæœ‰é€Ÿåº¦è€Œå·²å—ï¼Ÿé‚£è¿˜è·‘ä»€ä¹ˆï¼Œå»åæ–°å¹²çº¿ï¼Œå»åé£æœºï¼Œé‚£æ ·è¿˜æ¯”è¾ƒå¿«ã€‚ä½ æ€ä¹ˆè¿˜ä¸æ˜ç™½ï¼Œé˜¿èµ°ï¼Œä¸èƒ½ä¸€å‘³è¿½æ±‚é€Ÿåº¦ï¼Œé‚£æ ·åªä¼šè®©äººç©ºè™šã€‚â€”â€”æ¸…æ¿‘ç°äºŒ 
        </li>
        -->
        
            <li><a class="ba" href="/about">å…³äºæˆ‘ğŸƒ</a></li>
        
            <li><a class="ba" href="/categories">åˆ†ç±»ğŸšš</a></li>
        
            <li><a class="ba" target="_blank" rel="noopener" href="https://xblame.gitee.io">æ—§åšå®¢ğŸ‰</a></li>
        
            <li><a class="ba" target="_blank" rel="noopener" href="https://github.com/blameying">GitHubğŸ’</a></li>
        

            
<script src="/libs/jquery.min.js"></script>

            
<script src="/js/search.js"></script>

            
                <li>
                    <form class="site-search-form">
                        <i class="fa fa-search" id="search-logo"><input type="text" id="local-search-input" class="st-search-input" /></i>
                    </form>
                </li>
                <div class="words" style="font-weight: bold;font-family: Georgia;"> 
                        ä½ ä¸ºä»€ä¹ˆå°±ä¸æ˜¯è‚¯è®¤åŒå¤§å®¶çš„åŠªåŠ›ï¼Ÿå°±å› ä¸ºä»–ä»¬æ¯”ä½ æ…¢å—ï¼Ÿä½ çš„ä»·å€¼æ ‡å‡†å°±åªæœ‰é€Ÿåº¦è€Œå·²å—ï¼Ÿé‚£è¿˜è·‘ä»€ä¹ˆï¼Œå»åæ–°å¹²çº¿ï¼Œå»åé£æœºï¼Œé‚£æ ·è¿˜æ¯”è¾ƒå¿«ã€‚ä½ æ€ä¹ˆè¿˜ä¸æ˜ç™½ï¼Œé˜¿èµ°ï¼Œä¸èƒ½ä¸€å‘³è¿½æ±‚é€Ÿåº¦ï¼Œé‚£æ ·åªä¼šè®©äººç©ºè™šã€‚â€”â€”æ¸…æ¿‘ç°äºŒ 
                </div>
                <div id="local-search-result" class="local-search-result-cls"></div>
            
            <script type="text/javascript" id="local.search.active">
                var inputArea       = document.querySelector("#local-search-input");
                var getSearchFile = function(){
                    var path = "/search.xml";
                    searchFunc(path, 'local-search-input', 'local-search-result');
                }
                inputArea.onfocus = function(){ getSearchFile() }

                var $resetButton = $("#search-form .fa-times");
                var $resultArea = $("#local-search-result");

                inputArea.oninput = function(){ $resetButton.show(); }
                resetSearch = function(){
                    $resultArea.html("");
                    document.querySelector("#search-form").reset();
                    $resetButton.hide();
                    $(".no-result").hide();
                }
                inputArea.onkeydown = function(){ if(event.keyCode == 13) return false }
                //No search result
                $resultArea.bind("DOMNodeRemoved DOMNodeInserted", function(e) {
                    if (!$(e.target).text()) {
                        $(".no-result").show(100);
                    } else {
                        $(".no-result").hide();
                    }
                })
            </script>

    </ol>
    <hr>
</div>
    <div class="hd posts">
    <div class="post-title">
        <p>
            rCoreå®éªŒ-è™šæ‹Ÿåœ°å€åˆ°ç‰©ç†åœ°å€è½¬æ¢
        </p>
        <hr>
    </div>
    <div class="post-content">
        <p>æœ€è¿‘åœ¨çœ‹<a target="_blank" rel="noopener" href="https://github.com/LearningOS">rCoreæ“ä½œç³»ç»Ÿ</a>å®éªŒï¼Œåœ¨åšåˆ°è™šæ‹Ÿåœ°å€åˆ°ç‰©ç†åœ°å€è½¬æ¢è¿™ä¸€éƒ¨åˆ†èŠ±çš„æ—¶é—´æ¯”è¾ƒå¤šã€‚ä¹‹å‰ä¸»è¦æ˜¯ä»CPUçš„è§’åº¦å»ç†è§£MMUå¦‚ä½•è¿›è¡Œè™šæ‹Ÿåœ°å€åˆ°ç‰©ç†åœ°å€çš„è½¬æ¢ï¼Œå¤šçº§é¡µè¡¨æ˜¯å¦‚ä½•å¯»æ‰¾çš„ï¼ŒçŸ¥é“åº”è¯¥æœ‰è¿™ä¹ˆä¸€ä¸ªé¡µè¡¨ä¸“é—¨å­˜å‚¨ä¸‹ä¸€çº§é¡µè¡¨çš„åœ°å€æ•°ç»„ï¼Œä½†æ˜¯ä¸€å¼€å§‹çš„æ—¶å€™ç”±äºæ²¡æœ‰é€šè¯»æºç ï¼Œæ‰€ä»¥ä¸€ç›´æ²¡æ‰¾åˆ°è¿™éƒ¨åˆ†ã€‚æ‰€ä»¥ç»†è¯»äº†ä¸€ä¸‹rCoreå®éªŒåœ¨lab4_refç»™å‡ºçš„mméƒ¨åˆ†çš„ä»£ç ï¼Œä¸»è¦æ˜¯å¸¦ç€ä¸¤ä¸ªé—®é¢˜è¯»çš„ï¼š</p>
<ol>
<li>åœ¨satp(Supervisor Address Translation and Protectionï¼Œç›‘ç®¡è€…åœ°å€è½¬æ¢å’Œä¿æŠ¤)å¯„å­˜å™¨å‘ç”Ÿåœ°å€æ¨¡å¼åˆ‡æ¢ä»¥åï¼Œå†…æ ¸ä»£ç ä¸­å¯¹åŸæ¥å®åœ°å€æ¨¡å¼ä¸‹çš„æ•°æ®çš„è®¿é—®å¦‚ä½•ç»§ç»­ç”Ÿæ•ˆ</li>
<li>OSè§†è§’æ„å»ºé¡µè¡¨ç´¢å¼•çš„ç»†èŠ‚</li>
</ol>
<p>åœ¨<a target="_blank" rel="noopener" href="https://github.com/LearningOS/rust-based-os-comp2022/tree/main/os4-ref">é¡¹ç›®ç›®å½•</a>ä¸‹æœ‰ä»¥ä¸‹å‡ ä¸ªéƒ¨åˆ†:</p>
<table>
<thead>
<tr>
<th align="center">æ¨¡å—</th>
<th align="center">åŠŸèƒ½</th>
</tr>
</thead>
<tbody><tr>
<td align="center">mm</td>
<td align="center">å†…å­˜ç®¡ç†æ¨¡å—</td>
</tr>
<tr>
<td align="center">sync</td>
<td align="center">å¤šçº¿ç¨‹åŒæ­¥æ¨¡å—</td>
</tr>
<tr>
<td align="center">syscall</td>
<td align="center">ç³»ç»Ÿè°ƒç”¨æ¨¡å—</td>
</tr>
<tr>
<td align="center">task</td>
<td align="center">è¿›ç¨‹ç®¡ç†æ¨¡å—</td>
</tr>
<tr>
<td align="center">trap</td>
<td align="center">ä¸­æ–­æ¨¡å—</td>
</tr>
</tbody></table>
<p>è™šæ‹Ÿåœ°å€åˆ°ç‰©ç†åœ°å€çš„æ˜ å°„å’Œç®¡ç†ä¸»è¦åœ¨å†…å­˜ç®¡ç†æ¨¡å—ä¸­ï¼Œå†…å­˜ç®¡ç†æ¨¡å—ä¸»è¦å®Œæˆäº†ä»¥ä¸‹å‡ ä¸ªåŠŸèƒ½:</p>
<ul>
<li>å†…æ ¸å †å†…å­˜ç®¡ç†</li>
<li>é¡µè¡¨å†…å­˜åˆ†é…å’Œå›æ”¶</li>
<li>é¡µè¡¨ç›®å½•ç®¡ç†(è™šåœ°å€åˆ°å®åœ°å€çš„æ˜ å°„å…³ç³»ç»´æŠ¤)</li>
</ul>
<h3 id="å†…æ ¸å †å†…å­˜ç®¡ç†"><a href="#å†…æ ¸å †å†…å­˜ç®¡ç†" class="headerlink" title="å†…æ ¸å †å†…å­˜ç®¡ç†"></a>å†…æ ¸å †å†…å­˜ç®¡ç†</h3><p>æŒ‰ç…§ä¹‹å‰åµŒå…¥å¼å®æ—¶ç³»ç»Ÿä¸Šçš„ç»éªŒï¼Œæ“ä½œç³»ç»Ÿæœ¬èº«ç›´æ¥ä¸ç¡¬ä»¶æ‰“äº¤é“ï¼Œå› æ­¤ä¼šå®Œæˆâ€œå¼€å¤©è¾Ÿåœ°â€çš„è¿‡ç¨‹ï¼Œä¹Ÿå°±æ˜¯è¯´éœ€è¦æ„å»ºç¨‹åºè¿è¡Œçš„ç¯å¢ƒã€‚ç±»ä¼¼äºåº”ç”¨ç¨‹åºä¸­å†…å­˜åˆ†é…åŠŸèƒ½æ˜¯è¦è‡ªå·±æ¥å®ç°çš„ã€‚å› æ­¤ï¼Œå¸¸ç”¨çš„åšæ³•æ˜¯ï¼Œé€šè¿‡é™æ€å…¨å±€å˜é‡æ•°ç»„æ¥å æ®ä¸€æ®µè¿ç»­çš„å†…å­˜ç©ºé—´å½“ä½œå †å†…å­˜çš„å†…å­˜æ± ã€‚å†…æ ¸å †å†…å­˜ç®¡ç†åˆ™ä¸»è¦æ˜¯è´Ÿè´£å¯¹è¿™å—å†…å­˜æ± çš„ä½¿ç”¨è¿›è¡Œç®¡ç†ã€‚</p>
<p>åœ¨<a target="_blank" rel="noopener" href="https://github.com/LearningOS/rust-based-os-comp2022/blob/main/os4-ref/src/mm/heap_allocator.rs">heap_allocator.rs</a>æ–‡ä»¶ä¸­ä¸»è¦å®Œæˆäº†å†…æ ¸çš„å †å†…å­˜åˆ†é…ã€‚åœ¨æ­£å¸¸çš„åº”ç”¨ç¨‹åºç¼–å†™æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨stdåº“æ¥å®Œæˆæˆ‘ä»¬åœ¨å †ä¸Šçš„å†…å­˜åˆ†é…ï¼Œè¿™ä¸ªæ“ä½œä¸€èˆ¬æ˜¯<strong>new</strong>ï¼Œè€Œåœ¨è£¸æœºç¯å¢ƒä¸­æ˜¯æ²¡æœ‰stdç¯å¢ƒçš„ï¼Œè¿™ç§æƒ…å†µä¸‹å¯ä»¥ä½¿ç”¨<a target="_blank" rel="noopener" href="https://doc.rust-lang.org/alloc/index.html">alloc</a>åº“ï¼Œå®ƒçš„ä¸»è¦ä»‹ç»å¦‚ä¸‹ï¼š</p>
<blockquote>
<p>This library provides smart pointers and collections for managing heap-allocated values.</p>
<p>This library, like libcore, normally doesnâ€™t need to be used directly since its contents are re-exported in the std crate. Crates that use the #![no_std] attribute however will typically not depend on std, so theyâ€™d use this crate instead.</p>
</blockquote>
<p>å½“ä½¿ç”¨allocåº“è¿›è¡Œåˆ†é…æ—¶ï¼Œå¯ä»¥é€šè¿‡ <strong>#[global_allocator]</strong> å£°æ˜å°†è¦ä½¿ç”¨çš„åˆ†é…å™¨ï¼Œå¯ä»¥çœ‹åˆ°åœ¨ <strong>heap_allocator.rs</strong> ä¸­æŒ‡å®šäº†å †å†…å­˜åˆ†é…å™¨ï¼š</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#[global_allocator]</span></span><br><span class="line"><span class="comment">// heap allocator instance</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> HEAP_ALLOCATOR: LockedHeap = LockedHeap::<span class="title function_ invoke__">empty</span>();</span><br></pre></td></tr></table></figure>
<p>HEAP_ALLOCATORéœ€è¦å®ç° <strong>GlobalAlloc</strong> traitæ–¹å¯è¢«allocåº“æ­£ç¡®è°ƒç”¨ï¼Œ<strong>buddy-system_allocator</strong> ä¸­çš„ <strong>LockedHeap</strong> æœ‰å¦‚ä¸‹å®ç°ï¼š</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">unsafe</span> <span class="keyword">impl</span> <span class="title class_">GlobalAlloc</span> <span class="keyword">for</span> <span class="title class_">LockedHeap</span> &#123;</span><br><span class="line">    <span class="keyword">unsafe</span> <span class="keyword">fn</span> <span class="title function_">alloc</span>(&amp;<span class="keyword">self</span>, layout: Layout) <span class="punctuation">-&gt;</span> *<span class="keyword">mut</span> <span class="type">u8</span> &#123;</span><br><span class="line">        <span class="keyword">self</span>.<span class="number">0</span></span><br><span class="line">            .<span class="title function_ invoke__">lock</span>()</span><br><span class="line">            .<span class="title function_ invoke__">alloc</span>(layout)</span><br><span class="line">            .<span class="title function_ invoke__">ok</span>()</span><br><span class="line">            .<span class="title function_ invoke__">map_or</span>(<span class="number">0</span> <span class="keyword">as</span> *<span class="keyword">mut</span> <span class="type">u8</span>, |allocation| allocation.<span class="title function_ invoke__">as_ptr</span>())</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">unsafe</span> <span class="keyword">fn</span> <span class="title function_">dealloc</span>(&amp;<span class="keyword">self</span>, ptr: *<span class="keyword">mut</span> <span class="type">u8</span>, layout: Layout) &#123;</span><br><span class="line">        <span class="keyword">self</span>.<span class="number">0</span>.<span class="title function_ invoke__">lock</span>().<span class="title function_ invoke__">dealloc</span>(NonNull::<span class="title function_ invoke__">new_unchecked</span>(ptr), layout)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å› æ­¤å†…æ ¸å †å†…å­˜ç®¡ç†ä¸»è¦æ˜¯åˆ©ç”¨  <strong>alloc</strong> ä¸ <strong>buddy_system_allocator</strong> æ¥å®ç°çš„ã€‚</p>
<h3 id="é¡µè¡¨å†…å­˜åˆ†é…å’Œå›æ”¶"><a href="#é¡µè¡¨å†…å­˜åˆ†é…å’Œå›æ”¶" class="headerlink" title="é¡µè¡¨å†…å­˜åˆ†é…å’Œå›æ”¶"></a>é¡µè¡¨å†…å­˜åˆ†é…å’Œå›æ”¶</h3><p>å†…æ ¸ä¼šç®¡ç†å…¨éƒ¨çš„å†…å­˜åœ°å€ï¼Œå› æ­¤é™¤å»å†…æ ¸æ‰€å çš„å†…å­˜ç©ºé—´å¤–ï¼Œä»é“¾æ¥è„šæœ¬çš„ <strong>ekernelï¼ˆend of kernelï¼‰</strong> å¼€å§‹ç›´åˆ° <strong>MAX_MEMORY</strong> éƒ½å°†è¢«å†…æ ¸ä»¥é¡µè¡¨çš„å½¢å¼åŠ¨æ€ç®¡ç†ã€‚è¿™éƒ¨åˆ†çš„ä»£ç åœ¨ <a target="_blank" rel="noopener" href="https://github.com/LearningOS/rust-based-os-comp2022/blob/main/os4-ref/src/mm/frame_allocator.rs">frame_allocator.rs</a>ï¼Œé€šè¿‡ <strong>StackFrameAllocator</strong> æ¥è¿›è¡Œ <strong>stack(æ ˆ)</strong> é£æ ¼çš„å†…å­˜ç®¡ç†ï¼š</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// StackFrameAllocator</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">StackFrameAllocator</span> &#123;</span><br><span class="line">    current: <span class="type">usize</span>,</span><br><span class="line">    end: <span class="type">usize</span>,</span><br><span class="line">    recycled: <span class="type">Vec</span>&lt;<span class="type">usize</span>&gt;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨åˆå§‹åˆ†é…å†…å­˜æ—¶ï¼Œä¼šé€šè¿‡currentçš„é€’å¢æ¥å®ç°ã€‚åœ¨æœ‰å†…å­˜éœ€è¦å›æ”¶çš„æ—¶å€™ï¼Œå°†å…¶åœ°å€å­˜å…¥recycledåˆ—è¡¨ä¸­è¡¨ç¤ºå…¶å¯ç”¨ï¼Œè¿™ç§æƒ…å†µä¸‹å†æ¬¡æ”¶åˆ°åˆ†é…å†…å­˜çš„è¯·æ±‚å°±ä¼šä¼˜å…ˆä»recycledä¸­è¿›è¡Œåˆ†é…ã€‚</p>
<p><strong>FrameTracker</strong> åˆ™æ˜¯å†…æ ¸å¯¹åˆ†é…çš„ç‰©ç†é¡µè¡¨çš„ä¸€ä¸ªhandlerï¼Œå¯ä»¥é€šè¿‡å®ƒè®°å½•ç‰©ç†é¡µè¡¨çš„ç‰©ç†åœ°å€ï¼Œå½“è¯¥handlerç”Ÿå‘½å‘¨æœŸç»“æŸåï¼Œåˆ™ä¼šè‡ªåŠ¨å¯¹æŒ‡å®šçš„é¡µè¡¨è¿›è¡Œé‡Šæ”¾ã€‚</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">impl</span> <span class="title class_">Drop</span> <span class="keyword">for</span> <span class="title class_">FrameTracker</span> &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">drop</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="title function_ invoke__">frame_dealloc</span>(<span class="keyword">self</span>.ppn);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="é¡µè¡¨ç›®å½•ç®¡ç†"><a href="#é¡µè¡¨ç›®å½•ç®¡ç†" class="headerlink" title="é¡µè¡¨ç›®å½•ç®¡ç†"></a>é¡µè¡¨ç›®å½•ç®¡ç†</h3><p>åœ¨æ‹¥æœ‰ä¸Šä¸€èŠ‚å¯¹å…¨éƒ¨ç‰©ç†å†…å­˜çš„ç®€å•åˆ†é…å’Œå›æ”¶åŠŸèƒ½åï¼Œå¼€å¯è™šæ‹Ÿåœ°å€æ¨¡å¼çš„æœ€åä¸€éƒ¨åˆ†å·¥ä½œå°±æ˜¯å»ºç«‹è™šæ‹Ÿåœ°å€åˆ°ç‰©ç†åœ°å€çš„æ˜ å°„å…³ç³»äº†ã€‚<br><img src="https://blog-img-1310827095.cos.ap-beijing.myqcloud.com/virtualAddr_to_phy.svg" alt="virtualAddr_to_phy"></p>
<p>å¦‚å›¾æ‰€ç¤ºï¼Œè¿ç»­çš„è™šæ‹Ÿåœ°å€ä¸ä¸€å®šå¯¹åº”è¿ç»­çš„ç‰©ç†åœ°å€ï¼Œè€Œè¿™ä¸ªå¯¹åº”å…³ç³»éœ€è¦æ“ä½œç³»ç»ŸæŒ‰ç…§CPUæ”¯æŒçš„æ ¼å¼è¿›è¡Œç»´æŠ¤ã€‚ç”±è™šæ‹Ÿåœ°å€åˆ°ç‰©ç†åœ°å€çš„è½¬æ¢æ˜¯CPU MMUå™¨ä»¶è‡ªåŠ¨å‘ç”Ÿçš„ç¡¬ä»¶è¡Œä¸ºã€‚</p>
<p>rCoreé‡‡ç”¨çš„æ˜¯<a target="_blank" rel="noopener" href="http://rcore-os.cn/rCore-Tutorial-Book-v3/chapter4/3sv39-implementation-1.html">Sv39</a>çš„è½¬æ¢æ¨¡å¼ã€‚ä¸åœ°å€è½¬æ¢ç›¸å…³çš„å¯„å­˜å™¨ä¸º <strong>satp</strong> å¯„å­˜å™¨ï¼Œå®ƒçš„å¸ƒå±€æ˜¯ï¼š<br><img src="http://rcore-os.cn/rCore-Tutorial-Book-v3/_images/satp.png" alt="satp">, å…¶ä¸­PPNå­˜æ”¾çš„æ˜¯é¡µè¡¨çš„æ ¹åœ°å€ï¼Œå³å¤šçº§é¡µè¡¨ä¸­çš„ç¬¬ä¸€çº§é¡µè¡¨çš„åœ°å€ã€‚å½“é€šè¿‡é¡µè¡¨æ¥è¿›è¡Œåœ°å€è½¬æ¢æ—¶ï¼Œæµç¨‹å¦‚ä¸‹ï¼š</p>
<ol>
<li>é€šè¿‡satpä¸­çš„ppnè®¿é—®ç¬¬ä¸€çº§é¡µè¡¨çš„ç‰©ç†åœ°å€</li>
<li>è·å–è¯¥åœ°å€ä¸‹ï¼Œè™šæ‹Ÿåœ°å€çš„ç¬¬ä¸€çº§çš„åç§»ï¼Œæ‰¾åˆ°å¯¹åº”çš„ <strong>PTE</strong> èŠ‚ç‚¹ä¿¡æ¯ï¼Œç»§è€Œåˆ¤æ–­è¿™ä¸ªé¡µè¡¨é¡¹æŒ‡å‘çš„æ˜¯ä¸‹ä¸€çº§é¡µè¡¨è¿˜æ˜¯ç‰©ç†çš„å†…å­˜é¡µï¼Œå¦‚æœæ˜¯å†…å­˜é¡µåˆ™ç›´æ¥å¼€å§‹è¯»å†™æ“ä½œï¼Œå¦‚æœä»æ—§ä¸æ˜¯å¶ç»“ç‚¹åˆ™ç»§ç»­æŸ¥æ‰¾ä¸‹ä¸€çº§ã€‚ï¼ˆå…³äºPTEï¼Œè™šæ‹Ÿåœ°å€å’Œç‰©ç†åœ°å€çš„ç»“æ„ä¿¡æ¯ï¼Œå¯ä»¥æŸ¥çœ‹risc-vçš„<a target="_blank" rel="noopener" href="https://github.com/riscv/riscv-isa-manual/releases/download/Priv-v1.12/riscv-privileged-20211203.pdf">ç‰¹æƒçº§åˆ«æ¶æ„æ‰‹å†Œ</a></li>
</ol>
<p>åœ¨æ²¡æœ‰ç»†è¯»æºç çš„æ—¶å€™ï¼Œæˆ‘æ˜¯æ²¡æ‰¾åˆ°è¿™æ ·ä¸€å¼ è¡¨çš„ï¼Œå› ä¸ºä»æ¥æ²¡æœ‰åœ¨æ“ä½œç³»ç»Ÿçš„è§’åº¦çœ‹è¿‡é¡µè¡¨çš„ä½¿ç”¨ï¼Œå› æ­¤ä¸æ¸…æ¥šå®ƒæ˜¯éšç€ä½¿ç”¨è€Œä¸æ–­çš„æ”¹å˜çš„ã€‚</p>
<p>è¿™éƒ¨åˆ†çš„æºç åœ¨ <strong><a target="_blank" rel="noopener" href="https://github.com/LearningOS/rust-based-os-comp2022/blob/main/os4-ref/src/mm/page_table.rs">page_table.rs</a></strong> ä¸­ï¼Œ</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">impl</span> <span class="title class_">PageTable</span> &#123;</span><br><span class="line">    <span class="comment">// .......</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">find_pte_create</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, vpn: VirtPageNum) <span class="punctuation">-&gt;</span> <span class="type">Option</span>&lt;&amp;<span class="keyword">mut</span> PageTableEntry&gt; &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">idxs</span> = vpn.<span class="title function_ invoke__">indexes</span>();</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">ppn</span> = <span class="keyword">self</span>.root_ppn;</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">result</span>: <span class="type">Option</span>&lt;&amp;<span class="keyword">mut</span> PageTableEntry&gt; = <span class="literal">None</span>;</span><br><span class="line">        <span class="title function_ invoke__">for</span> (i, idx) <span class="keyword">in</span> idxs.<span class="title function_ invoke__">iter_mut</span>().<span class="title function_ invoke__">enumerate</span>() &#123;</span><br><span class="line">            <span class="keyword">let</span> <span class="variable">pte</span> = &amp;<span class="keyword">mut</span> ppn.<span class="title function_ invoke__">get_pte_array</span>()[*idx];</span><br><span class="line">            <span class="keyword">if</span> i == <span class="number">2</span> &#123;</span><br><span class="line">                result = <span class="title function_ invoke__">Some</span>(pte);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> !pte.<span class="title function_ invoke__">is_valid</span>() &#123;</span><br><span class="line">                <span class="keyword">let</span> <span class="variable">frame</span> = <span class="title function_ invoke__">frame_alloc</span>().<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">                *pte = PageTableEntry::<span class="title function_ invoke__">new</span>(frame.ppn, PTEFlags::V);</span><br><span class="line">                <span class="keyword">self</span>.frames.<span class="title function_ invoke__">push</span>(frame);</span><br><span class="line">            &#125;</span><br><span class="line">            ppn = pte.<span class="title function_ invoke__">ppn</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        result</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">find_pte</span>(&amp;<span class="keyword">self</span>, vpn: VirtPageNum) <span class="punctuation">-&gt;</span> <span class="type">Option</span>&lt;&amp;PageTableEntry&gt; &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">idxs</span> = vpn.<span class="title function_ invoke__">indexes</span>();</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">ppn</span> = <span class="keyword">self</span>.root_ppn;</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">result</span>: <span class="type">Option</span>&lt;&amp;PageTableEntry&gt; = <span class="literal">None</span>;</span><br><span class="line">        <span class="title function_ invoke__">for</span> (i, idx) <span class="keyword">in</span> idxs.<span class="title function_ invoke__">iter</span>().<span class="title function_ invoke__">enumerate</span>() &#123;</span><br><span class="line">            <span class="keyword">let</span> <span class="variable">pte</span> = &amp;ppn.<span class="title function_ invoke__">get_pte_array</span>()[*idx];</span><br><span class="line">            <span class="keyword">if</span> i == <span class="number">2</span> &#123;</span><br><span class="line">                result = <span class="title function_ invoke__">Some</span>(pte);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> !pte.<span class="title function_ invoke__">is_valid</span>() &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">None</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            ppn = pte.<span class="title function_ invoke__">ppn</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        result</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°ï¼Œåœ¨ <strong>find_pte_create</strong> æ–¹æ³•ä¸­ï¼Œ<strong>pte</strong> éæ³•æ—¶ä¼šé€šè¿‡ä¸Šæ®µæåˆ°çš„é¡µè¡¨å†…å­˜åˆ†é…æ¥å£è¿›è¡ŒåŠ¨æ€çš„åˆ†é…ï¼Œå¹¶å°†å…¶ç‰©ç†åœ°å€ <strong>frame.ppn</strong> å†™å…¥ <strong>pte</strong> ä¸­,è€Œå½“åˆæ³•æ—¶ï¼Œåˆ™ç›´æ¥è¿”å›ã€‚</p>
<p>é€šè¿‡ä¸Šè¿°çš„å‡ æ®µåˆ†æï¼ŒåŸºæœ¬ä¸Šæ¶µç›–äº†å†…æ ¸æ‰€é‡åˆ°çš„å†…å­˜æ–¹é¢çš„ç®¡ç†ã€‚é‚£è¿˜æœ‰æœ€åä¸€ä¸ªç–‘é—®æ˜¯ï¼Œå½“å¤„ç†å™¨çš„åœ°å€æ¨¡å¼ç”±å®åœ°å€å˜ä¸ºè™šåœ°å€æ—¶ï¼ŒåŸæ¥å†…æ ¸éƒ¨åˆ†çš„ä»£ç å¦‚ä½•æ­£å¸¸è¿è¡Œï¼Œè¦çŸ¥é“å†…æ ¸ä¸­å¹¶ä¸æ˜¯æ‰€æœ‰å˜é‡ç”¨çš„éƒ½æ˜¯ç›¸å¯¹åœ°å€ï¼ŒåŒ…æ‹¬ä¸€äº›ç‰©ç†å¤–è®¾çš„è®¿é—®åœ°å€éƒ½æ˜¯å›ºå®šçš„ã€‚</p>
<p>æˆ‘å»å¯¹æ¯”äº†ä¸€ä¸‹å¸¦ <strong>mm</strong> æ¨¡å—å‰çš„ <strong>os</strong> å®éªŒï¼Œå‘ç°ç¼–è¯‘å™¨æ–¹é¢å¹¶æ²¡æœ‰æ·»åŠ ä»€ä¹ˆä¸ä¹‹ç›¸å…³çš„ç¼–è¯‘å‚æ•°ï¼Œåªèƒ½æ˜¯åœ¨ä»£ç é‡Œåšçš„æ‰‹è„šï¼Œå‘ç°è¿™éƒ¨åˆ†çš„å¤„ç†åœ¨ <strong><a target="_blank" rel="noopener" href="https://github.com/LearningOS/rust-based-os-comp2022/blob/main/os4-ref/src/mm/memory_set.rs">memory_set.rs</a></strong> æ–‡ä»¶ä¸­ï¼Œ </p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="keyword">enum</span> <span class="title class_">MapType</span> &#123;</span><br><span class="line">    Identical,</span><br><span class="line">    Framed,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">MapArea</span> &#123;</span><br><span class="line">    vpn_range: VPNRange,</span><br><span class="line">    data_frames: BTreeMap&lt;VirtPageNum, FrameTracker&gt;,</span><br><span class="line">    map_type: MapType,</span><br><span class="line">    map_perm: MapPermission,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œå®šä¹‰äº†ä¸¤ç§çš„è™šæ‹Ÿåœ°å€åˆ°ç‰©ç†åœ°å€æ˜ å°„æ–¹å¼ï¼Œå…¶ä¸­ <strong>Framed</strong> çš„æ–¹å¼å°±æ˜¯å‰æ–‡æåˆ°çš„åˆ†é…å†…å­˜çš„æ–¹å¼ï¼Œé‚£è¿™ç§è™šæ‹Ÿåœ°å€å’Œç‰©ç†åœ°å€çš„æ˜ å°„æ˜¯æ²¡æœ‰å­—é¢ä¸Šçš„è”ç³»çš„ï¼Œä¹Ÿå°±æ˜¯ä¸æŸ¥è¡¨çš„æƒ…å†µä¸‹ï¼Œæ˜¯çœ‹ä¸å‡ºå…³è”çš„ï¼Œ</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">new_kernel</span>() <span class="punctuation">-&gt;</span> <span class="keyword">Self</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">memory_set</span> = <span class="keyword">Self</span>::<span class="title function_ invoke__">new_bare</span>();</span><br><span class="line">    <span class="comment">// map trampoline</span></span><br><span class="line">    memory_set.<span class="title function_ invoke__">map_trampoline</span>();</span><br><span class="line">    <span class="comment">// map kernel sections</span></span><br><span class="line">    info!(<span class="string">&quot;.text [&#123;:#x&#125;, &#123;:#x&#125;)&quot;</span>, stext <span class="keyword">as</span> <span class="type">usize</span>, etext <span class="keyword">as</span> <span class="type">usize</span>);</span><br><span class="line">    info!(<span class="string">&quot;.rodata [&#123;:#x&#125;, &#123;:#x&#125;)&quot;</span>, srodata <span class="keyword">as</span> <span class="type">usize</span>, erodata <span class="keyword">as</span> <span class="type">usize</span>);</span><br><span class="line">    info!(<span class="string">&quot;.data [&#123;:#x&#125;, &#123;:#x&#125;)&quot;</span>, sdata <span class="keyword">as</span> <span class="type">usize</span>, edata <span class="keyword">as</span> <span class="type">usize</span>);</span><br><span class="line">    info!(</span><br><span class="line">        <span class="string">&quot;.bss [&#123;:#x&#125;, &#123;:#x&#125;)&quot;</span>,</span><br><span class="line">        sbss_with_stack <span class="keyword">as</span> <span class="type">usize</span>, ebss <span class="keyword">as</span> <span class="type">usize</span></span><br><span class="line">    );</span><br><span class="line">    info!(<span class="string">&quot;mapping .text section&quot;</span>);</span><br><span class="line">    memory_set.<span class="title function_ invoke__">push</span>(</span><br><span class="line">        MapArea::<span class="title function_ invoke__">new</span>(</span><br><span class="line">            (stext <span class="keyword">as</span> <span class="type">usize</span>).<span class="title function_ invoke__">into</span>(),</span><br><span class="line">            (etext <span class="keyword">as</span> <span class="type">usize</span>).<span class="title function_ invoke__">into</span>(),</span><br><span class="line">            MapType::Identical,</span><br><span class="line">            MapPermission::R | MapPermission::X,</span><br><span class="line">        ),</span><br><span class="line">        <span class="literal">None</span>,</span><br><span class="line">    );</span><br><span class="line">    info!(<span class="string">&quot;mapping .rodata section&quot;</span>);</span><br><span class="line">    memory_set.<span class="title function_ invoke__">push</span>(</span><br><span class="line">        MapArea::<span class="title function_ invoke__">new</span>(</span><br><span class="line">            (srodata <span class="keyword">as</span> <span class="type">usize</span>).<span class="title function_ invoke__">into</span>(),</span><br><span class="line">            (erodata <span class="keyword">as</span> <span class="type">usize</span>).<span class="title function_ invoke__">into</span>(),</span><br><span class="line">            MapType::Identical,</span><br><span class="line">            MapPermission::R,</span><br><span class="line">        ),</span><br><span class="line">        <span class="literal">None</span>,</span><br><span class="line">    );</span><br><span class="line">    info!(<span class="string">&quot;mapping .data section&quot;</span>);</span><br><span class="line">    memory_set.<span class="title function_ invoke__">push</span>(</span><br><span class="line">        MapArea::<span class="title function_ invoke__">new</span>(</span><br><span class="line">            (sdata <span class="keyword">as</span> <span class="type">usize</span>).<span class="title function_ invoke__">into</span>(),</span><br><span class="line">            (edata <span class="keyword">as</span> <span class="type">usize</span>).<span class="title function_ invoke__">into</span>(),</span><br><span class="line">            MapType::Identical,</span><br><span class="line">            MapPermission::R | MapPermission::W,</span><br><span class="line">        ),</span><br><span class="line">        <span class="literal">None</span>,</span><br><span class="line">    );</span><br><span class="line">    info!(<span class="string">&quot;mapping .bss section&quot;</span>);</span><br><span class="line">    memory_set.<span class="title function_ invoke__">push</span>(</span><br><span class="line">        MapArea::<span class="title function_ invoke__">new</span>(</span><br><span class="line">            (sbss_with_stack <span class="keyword">as</span> <span class="type">usize</span>).<span class="title function_ invoke__">into</span>(),</span><br><span class="line">            (ebss <span class="keyword">as</span> <span class="type">usize</span>).<span class="title function_ invoke__">into</span>(),</span><br><span class="line">            MapType::Identical,</span><br><span class="line">            MapPermission::R | MapPermission::W,</span><br><span class="line">        ),</span><br><span class="line">        <span class="literal">None</span>,</span><br><span class="line">    );</span><br><span class="line">    info!(<span class="string">&quot;mapping physical memory&quot;</span>);</span><br><span class="line">    memory_set.<span class="title function_ invoke__">push</span>(</span><br><span class="line">        MapArea::<span class="title function_ invoke__">new</span>(</span><br><span class="line">            (ekernel <span class="keyword">as</span> <span class="type">usize</span>).<span class="title function_ invoke__">into</span>(),</span><br><span class="line">            MEMORY_END.<span class="title function_ invoke__">into</span>(),</span><br><span class="line">            MapType::Identical,</span><br><span class="line">            MapPermission::R | MapPermission::W,</span><br><span class="line">        ),</span><br><span class="line">        <span class="literal">None</span>,</span><br><span class="line">    );</span><br><span class="line">    memory_set</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨å®šä¹‰ <strong>new_kernel</strong> æ–¹æ³•çš„æ—¶å€™ï¼Œå¼•ç”¨äº†å¤§é‡çš„é“¾æ¥æ–‡ä»¶ä¸­å®šä¹‰çš„å…¨å±€å˜é‡ï¼Œæ¯”å¦‚ <strong>sbss,ebss,stext,etext</strong> ç­‰ï¼Œå¯ä»¥çœ‹åˆ°ï¼Œè¿™äº›å·²æœ‰çš„ç¨‹åºéœ€è¦ä½¿ç”¨çš„åœ°å€éƒ½è¿›è¡Œäº† <strong>Identical</strong> ç±»å‹çš„æ˜ å°„ã€‚</p>
<p>åœ¨ <strong>MapArea</strong> çš„ <strong>map_one</strong> æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥å‘ç°ï¼Œ <strong>Identical</strong> æ˜¯ä¸éœ€è¦å†æ¬¡åˆ†é…å†…å­˜æ¥è¿›è¡Œæ˜ å°„çš„ï¼Œè€Œæ˜¯ç›´æ¥æŠŠä¼ è¿›æ¥çš„åœ°å€ä½œä¸ºç‰©ç†åœ°å€ä½¿ç”¨ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œä¸ºäº†ä¿è¯åœ¨åˆ‡æ¢åœ°å€æ¨¡å¼åï¼Œå†…æ ¸çš„ä»£ç ä»æ—§èƒ½å¤Ÿæ­£å¸¸å·¥ä½œï¼Œå®ƒç”¨åŒæ ·çš„è™šæ‹Ÿåœ°å€æŒ‡å‘äº†åŸæ¥çš„ç‰©ç†åœ°å€ï¼Œå³å»ºç«‹äº†0x80000000(è™šæ‹Ÿåœ°å€)åˆ°0x80000000(ç‰©ç†åœ°å€)çš„è”ç³»ï¼Œè¿™éƒ¨åˆ†ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">map_one</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, page_table: &amp;<span class="keyword">mut</span> PageTable, vpn: VirtPageNum) &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">ppn</span>: PhysPageNum;</span><br><span class="line">    <span class="keyword">match</span> <span class="keyword">self</span>.map_type &#123;</span><br><span class="line">        MapType::Identical =&gt; &#123;</span><br><span class="line">            ppn = <span class="title function_ invoke__">PhysPageNum</span>(vpn.<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        MapType::Framed =&gt; &#123;</span><br><span class="line">            <span class="keyword">let</span> <span class="variable">frame</span> = <span class="title function_ invoke__">frame_alloc</span>().<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">            ppn = frame.ppn;</span><br><span class="line">            <span class="keyword">self</span>.data_frames.<span class="title function_ invoke__">insert</span>(vpn, frame);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">pte_flags</span> = PTEFlags::<span class="title function_ invoke__">from_bits</span>(<span class="keyword">self</span>.map_perm.bits).<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">    page_table.<span class="title function_ invoke__">map</span>(vpn, ppn, pte_flags);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>






    </div>

    
        <div id="gitalk-container"></div>
        <link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css">
        <script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>
        <script type="text/javascript">
            const gitalk = new Gitalk({
                clientID: "878e0dc683b1e7b833f9",
                clientSecret: "c592d75254a393f7760494f50ae37263ac5f92c3",
                repo: "blog-comments",      // The repository of store comments,
                owner: "Blameying",
                admin: ["Blameying"],
                id: location.pathname,      // Ensure uniqueness and length less than 50
                distractionFreeMode: false  // Facebook-like distraction free mode
            })

            gitalk.render('gitalk-container')
        </script>
    
</div>
    <div class="footer" id="footer">
    <p><h4>ç‰ˆæƒæ‰€æœ‰ Â© 2020 | ä½œè€…: Blame | ä¸»é¢˜ By <a class="theme-author" target="_blank" rel="noopener" href="https://github.com/Xunzhuo/hexo-theme-coder" style="font-size:14px; color: #969696">Coder</a></h4>
    
        <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
        <span id="busuanzi_container_site_pv">æœ¬ç«™æµè§ˆæ€»è®¿é—®é‡: <span id="busuanzi_value_site_pv"></span></span>
        <span class="post-meta-divider">|</span>
        <span id="busuanzi_container_site_uv">æœ¬ç«™è®¿é—®äººæ•°: <span id="busuanzi_value_site_uv"></span></span>
    
    <label class="el-switch el-switch-blue el-switch-sm" style="vertical-align: sub;">
        <input type="checkbox" name="switch" id="update_style">
        <span class="el-switch-style"></span>
    </label>

    <!--         <script type="text/javascript">
    var cnzz_protocol = (("https:" == document.location.protocol) ? "https://" : "http://");
    document.write(unescape("%3Cspan id='cnzz_stat_icon_1278548644'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "v1.cnzz.com/stat.php%3Fid%3D1278548644%26show%3Dpic1' type='text/javascript'%3E%3C/script%3E"));
    </script> -->
</p>
</div>

<input type="hidden" id="web_style" value="black">
<input type="hidden" id="valine_appid" value="">
<input type="hidden" id="valine_appKey" value="">

<script src="/libs/jquery.min.js"></script>


<script src="/libs/highlight/highlight.pack.js"></script>

<script src='//cdn.jsdelivr.net/npm/valine@1.3.10/dist/Valine.min.js'></script>

<script src="/js/js.js"></script>

<style type="text/css">
.v * {
color: #698fca;
}
.v .vlist .vcard .vhead .vsys {
color: #3a3e4a;
}
.v .vlist .vcard .vh .vmeta .vat {
color: #638fd5;
}
.v .vlist .vcard .vhead .vnick {
color: #6ba1ff;
}
.v a {
color: #8696b1;
}
.v .vlist .vcard .vhead .vnick:hover {
color: #669bfc;
}
</style>
    <script type="text/javascript" color="173,174,173" opacity='1' zIndex="-2" count="99" src="//cdn.bootcss.com/canvas-nest.js/1.0.0/canvas-nest.min.js"></script>
</body>
</html>
